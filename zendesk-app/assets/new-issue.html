<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/combine/npm/@zendeskgarden/css-bedrock@7.0.21,npm/@zendeskgarden/css-utilities@4.3.0">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="glitzi-container">
        <div loading-splash class="splash">Loading...</div>
        <div dynamic-fields></div>
        <div static-field class="comment-get-container hidden">
            Copy text from: <a href="javascript:void(0)" comment-getter="first">first message</a> or <a comment-getter="last" href="javascript:void(0)">last message</a>
        </div>
        <div static-field class="field-value hidden">
            <div class="field">Description</div>
            <div class="value">
                <textarea style="width:100%;height:200px;" glizi-value="description">
**Preconditions:**

**What did you do:**

**What happened:**

**What did you expect?:**
</textarea>
            </div>
        </div>
    </div>
    <div buttons class="buttons-container">
        <button cancel-btn class="secondary">Cancel</button>
        <button issue-create-btn class="primary" disabled>Create</button>
    </div>
    <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>
    <script src="main.js"></script>
    <script>
        var client = ZAFClient.init();
        client.invoke('resize', { width: '600px', height: '700px' });
        client.on('got-comment', (comment) => {
            document.querySelector('[glizi-value="description"]').innerHTML = comment;
        });
        glizi.init(client, () => {
            var container = document.querySelector("[dynamic-fields]");
            var splash = document.querySelector("[loading-splash]");
            var staticFields = document.querySelectorAll("[static-field]");
            var params = glizi.convertParams();
            var parentClient = client.instance(params.parentId);

            container.append(glizi.newDropdownValueElement("Project", glizi.modules));
            container.append(glizi.newDropdownValueElement("Type", glizi.issueTypes));
            container.append(glizi.newDropdownValueElement("Priority", glizi.issuePriorities));
            container.append(glizi.newDropdownValueElement("Sprint", glizi.sprints));
            container.append(glizi.newInputValueElement("Title", params.subject));
            for (var i = 0; i < staticFields.length; i++) {
                staticFields[i].classList = [...staticFields[i].classList].filter((i) => i !== "hidden");
            }
            splash.className = `${splash.className} hidden`

            var cancelBtn = document.querySelector("[cancel-btn]");
            cancelBtn.addEventListener("click", () => {
                client.invoke('destroy');
            });

            var createBtn = document.querySelector("[issue-create-btn]");
            createBtn.removeAttribute("disabled");
            createBtn.addEventListener("click", () => {
                glizi.newIssue(glizi.prepareForSending(params), () => {
                    parentClient.trigger('refetch-links');
                    client.invoke('destroy');
                });
            });

            var firstCommentGetter = document.querySelector('[comment-getter="first"]');
            firstCommentGetter.addEventListener("click", () => {
                parentClient.trigger('get-comment', -1);
            });
            
            var lastCommentGetter = document.querySelector('[comment-getter="last"]');
            lastCommentGetter.addEventListener("click", () => {
                parentClient.trigger('get-comment', 0);
            });
        });
    </script>
</body>

</html>